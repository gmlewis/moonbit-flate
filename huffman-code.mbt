/// This file is based on the Go implementation found here:
/// https://cs.opensource.google/go/go/+/refs/tags/go1.23.1:src/compress/flate/huffman_code.go
/// which has the copyright notice:
/// Copyright 2009 The Go Authors. All rights reserved.
/// Use of this source code is governed by a BSD-style
/// license that can be found in the LICENSE file.

struct HuffmanEncoder {
  codes : Array[HCode]
  freqcache : Array[LiteralNode]
  bit_count : FixedArray[Int] // [17]int32
  // lns       : byLiteral // stored to avoid repeated allocation in generate
  // lfs       : byFreq    // stored to avoid repeated allocation in generate
} derive(Show, Eq)

fn HuffmanEncoder::new(size : Int) -> HuffmanEncoder {
  let codes = Array::make(size, { code: 0U, len: 0U })
  let freqcache = []
  let bit_count = FixedArray::make(17, 0)
  { codes, freqcache, bit_count }
}

struct LiteralNode {
  literal : UInt // uint16
  freq : UInt
} derive(Show, Eq)

// HCode is a huffman code with a bit code and bit length.
struct HCode {
  code : UInt
  len : UInt
} derive(Show, Eq)

let fixed_literal_encoding : Array[HCode] = [
  { code: 12, len: 8 },
  { code: 140, len: 8 },
  { code: 76, len: 8 },
  { code: 204, len: 8 },
  { code: 44, len: 8 },
  { code: 172, len: 8 },
  { code: 108, len: 8 },
  { code: 236, len: 8 },
  { code: 28, len: 8 },
  { code: 156, len: 8 },
  { code: 92, len: 8 },
  { code: 220, len: 8 },
  { code: 60, len: 8 },
  { code: 188, len: 8 },
  { code: 124, len: 8 },
  { code: 252, len: 8 },
  { code: 2, len: 8 },
  { code: 130, len: 8 },
  { code: 66, len: 8 },
  { code: 194, len: 8 },
  { code: 34, len: 8 },
  { code: 162, len: 8 },
  { code: 98, len: 8 },
  { code: 226, len: 8 },
  { code: 18, len: 8 },
  { code: 146, len: 8 },
  { code: 82, len: 8 },
  { code: 210, len: 8 },
  { code: 50, len: 8 },
  { code: 178, len: 8 },
  { code: 114, len: 8 },
  { code: 242, len: 8 },
  { code: 10, len: 8 },
  { code: 138, len: 8 },
  { code: 74, len: 8 },
  { code: 202, len: 8 },
  { code: 42, len: 8 },
  { code: 170, len: 8 },
  { code: 106, len: 8 },
  { code: 234, len: 8 },
  { code: 26, len: 8 },
  { code: 154, len: 8 },
  { code: 90, len: 8 },
  { code: 218, len: 8 },
  { code: 58, len: 8 },
  { code: 186, len: 8 },
  { code: 122, len: 8 },
  { code: 250, len: 8 },
  { code: 6, len: 8 },
  { code: 134, len: 8 },
  { code: 70, len: 8 },
  { code: 198, len: 8 },
  { code: 38, len: 8 },
  { code: 166, len: 8 },
  { code: 102, len: 8 },
  { code: 230, len: 8 },
  { code: 22, len: 8 },
  { code: 150, len: 8 },
  { code: 86, len: 8 },
  { code: 214, len: 8 },
  { code: 54, len: 8 },
  { code: 182, len: 8 },
  { code: 118, len: 8 },
  { code: 246, len: 8 },
  { code: 14, len: 8 },
  { code: 142, len: 8 },
  { code: 78, len: 8 },
  { code: 206, len: 8 },
  { code: 46, len: 8 },
  { code: 174, len: 8 },
  { code: 110, len: 8 },
  { code: 238, len: 8 },
  { code: 30, len: 8 },
  { code: 158, len: 8 },
  { code: 94, len: 8 },
  { code: 222, len: 8 },
  { code: 62, len: 8 },
  { code: 190, len: 8 },
  { code: 126, len: 8 },
  { code: 254, len: 8 },
  { code: 1, len: 8 },
  { code: 129, len: 8 },
  { code: 65, len: 8 },
  { code: 193, len: 8 },
  { code: 33, len: 8 },
  { code: 161, len: 8 },
  { code: 97, len: 8 },
  { code: 225, len: 8 },
  { code: 17, len: 8 },
  { code: 145, len: 8 },
  { code: 81, len: 8 },
  { code: 209, len: 8 },
  { code: 49, len: 8 },
  { code: 177, len: 8 },
  { code: 113, len: 8 },
  { code: 241, len: 8 },
  { code: 9, len: 8 },
  { code: 137, len: 8 },
  { code: 73, len: 8 },
  { code: 201, len: 8 },
  { code: 41, len: 8 },
  { code: 169, len: 8 },
  { code: 105, len: 8 },
  { code: 233, len: 8 },
  { code: 25, len: 8 },
  { code: 153, len: 8 },
  { code: 89, len: 8 },
  { code: 217, len: 8 },
  { code: 57, len: 8 },
  { code: 185, len: 8 },
  { code: 121, len: 8 },
  { code: 249, len: 8 },
  { code: 5, len: 8 },
  { code: 133, len: 8 },
  { code: 69, len: 8 },
  { code: 197, len: 8 },
  { code: 37, len: 8 },
  { code: 165, len: 8 },
  { code: 101, len: 8 },
  { code: 229, len: 8 },
  { code: 21, len: 8 },
  { code: 149, len: 8 },
  { code: 85, len: 8 },
  { code: 213, len: 8 },
  { code: 53, len: 8 },
  { code: 181, len: 8 },
  { code: 117, len: 8 },
  { code: 245, len: 8 },
  { code: 13, len: 8 },
  { code: 141, len: 8 },
  { code: 77, len: 8 },
  { code: 205, len: 8 },
  { code: 45, len: 8 },
  { code: 173, len: 8 },
  { code: 109, len: 8 },
  { code: 237, len: 8 },
  { code: 29, len: 8 },
  { code: 157, len: 8 },
  { code: 93, len: 8 },
  { code: 221, len: 8 },
  { code: 61, len: 8 },
  { code: 189, len: 8 },
  { code: 125, len: 8 },
  { code: 253, len: 8 },
  { code: 19, len: 9 },
  { code: 275, len: 9 },
  { code: 147, len: 9 },
  { code: 403, len: 9 },
  { code: 83, len: 9 },
  { code: 339, len: 9 },
  { code: 211, len: 9 },
  { code: 467, len: 9 },
  { code: 51, len: 9 },
  { code: 307, len: 9 },
  { code: 179, len: 9 },
  { code: 435, len: 9 },
  { code: 115, len: 9 },
  { code: 371, len: 9 },
  { code: 243, len: 9 },
  { code: 499, len: 9 },
  { code: 11, len: 9 },
  { code: 267, len: 9 },
  { code: 139, len: 9 },
  { code: 395, len: 9 },
  { code: 75, len: 9 },
  { code: 331, len: 9 },
  { code: 203, len: 9 },
  { code: 459, len: 9 },
  { code: 43, len: 9 },
  { code: 299, len: 9 },
  { code: 171, len: 9 },
  { code: 427, len: 9 },
  { code: 107, len: 9 },
  { code: 363, len: 9 },
  { code: 235, len: 9 },
  { code: 491, len: 9 },
  { code: 27, len: 9 },
  { code: 283, len: 9 },
  { code: 155, len: 9 },
  { code: 411, len: 9 },
  { code: 91, len: 9 },
  { code: 347, len: 9 },
  { code: 219, len: 9 },
  { code: 475, len: 9 },
  { code: 59, len: 9 },
  { code: 315, len: 9 },
  { code: 187, len: 9 },
  { code: 443, len: 9 },
  { code: 123, len: 9 },
  { code: 379, len: 9 },
  { code: 251, len: 9 },
  { code: 507, len: 9 },
  { code: 7, len: 9 },
  { code: 263, len: 9 },
  { code: 135, len: 9 },
  { code: 391, len: 9 },
  { code: 71, len: 9 },
  { code: 327, len: 9 },
  { code: 199, len: 9 },
  { code: 455, len: 9 },
  { code: 39, len: 9 },
  { code: 295, len: 9 },
  { code: 167, len: 9 },
  { code: 423, len: 9 },
  { code: 103, len: 9 },
  { code: 359, len: 9 },
  { code: 231, len: 9 },
  { code: 487, len: 9 },
  { code: 23, len: 9 },
  { code: 279, len: 9 },
  { code: 151, len: 9 },
  { code: 407, len: 9 },
  { code: 87, len: 9 },
  { code: 343, len: 9 },
  { code: 215, len: 9 },
  { code: 471, len: 9 },
  { code: 55, len: 9 },
  { code: 311, len: 9 },
  { code: 183, len: 9 },
  { code: 439, len: 9 },
  { code: 119, len: 9 },
  { code: 375, len: 9 },
  { code: 247, len: 9 },
  { code: 503, len: 9 },
  { code: 15, len: 9 },
  { code: 271, len: 9 },
  { code: 143, len: 9 },
  { code: 399, len: 9 },
  { code: 79, len: 9 },
  { code: 335, len: 9 },
  { code: 207, len: 9 },
  { code: 463, len: 9 },
  { code: 47, len: 9 },
  { code: 303, len: 9 },
  { code: 175, len: 9 },
  { code: 431, len: 9 },
  { code: 111, len: 9 },
  { code: 367, len: 9 },
  { code: 239, len: 9 },
  { code: 495, len: 9 },
  { code: 31, len: 9 },
  { code: 287, len: 9 },
  { code: 159, len: 9 },
  { code: 415, len: 9 },
  { code: 95, len: 9 },
  { code: 351, len: 9 },
  { code: 223, len: 9 },
  { code: 479, len: 9 },
  { code: 63, len: 9 },
  { code: 319, len: 9 },
  { code: 191, len: 9 },
  { code: 447, len: 9 },
  { code: 127, len: 9 },
  { code: 383, len: 9 },
  { code: 255, len: 9 },
  { code: 511, len: 9 },
  { code: 0, len: 7 },
  { code: 64, len: 7 },
  { code: 32, len: 7 },
  { code: 96, len: 7 },
  { code: 16, len: 7 },
  { code: 80, len: 7 },
  { code: 48, len: 7 },
  { code: 112, len: 7 },
  { code: 8, len: 7 },
  { code: 72, len: 7 },
  { code: 40, len: 7 },
  { code: 104, len: 7 },
  { code: 24, len: 7 },
  { code: 88, len: 7 },
  { code: 56, len: 7 },
  { code: 120, len: 7 },
  { code: 4, len: 7 },
  { code: 68, len: 7 },
  { code: 36, len: 7 },
  { code: 100, len: 7 },
  { code: 20, len: 7 },
  { code: 84, len: 7 },
  { code: 52, len: 7 },
  { code: 116, len: 7 },
  { code: 3, len: 8 },
  { code: 131, len: 8 },
  { code: 67, len: 8 },
  { code: 195, len: 8 },
  { code: 35, len: 8 },
  { code: 163, len: 8 },
]

let fixed_offset_encoding : Array[HCode] = [
  { code: 0, len: 5 },
  { code: 16, len: 5 },
  { code: 8, len: 5 },
  { code: 24, len: 5 },
  { code: 4, len: 5 },
  { code: 20, len: 5 },
  { code: 12, len: 5 },
  { code: 28, len: 5 },
  { code: 2, len: 5 },
  { code: 18, len: 5 },
  { code: 10, len: 5 },
  { code: 26, len: 5 },
  { code: 6, len: 5 },
  { code: 22, len: 5 },
  { code: 14, len: 5 },
  { code: 30, len: 5 },
  { code: 1, len: 5 },
  { code: 17, len: 5 },
  { code: 9, len: 5 },
  { code: 25, len: 5 },
  { code: 5, len: 5 },
  { code: 21, len: 5 },
  { code: 13, len: 5 },
  { code: 29, len: 5 },
  { code: 3, len: 5 },
  { code: 19, len: 5 },
  { code: 11, len: 5 },
  { code: 27, len: 5 },
  { code: 7, len: 5 },
  { code: 23, len: 5 },
]
